# Auto-FPS-Clipper å‡¦ç†ãƒ•ãƒ­ãƒ¼è©³ç´°

## ğŸ“‹ ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒ•ãƒ­ãƒ¼](#ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒ•ãƒ­ãƒ¼)
2. [è©³ç´°å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—](#è©³ç´°å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—)
3. [å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²](#å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³)
5. [APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ](#apiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)
6. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)

---

## ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Upload)                            â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚ ãƒ»å¯¾å¿œå½¢å¼: MP4, MKV, AVI, MOV                              â”‚
â”‚ ãƒ»æœ€å¤§ã‚µã‚¤ã‚º: 5GB                                           â”‚
â”‚ ãƒ»ä¿å­˜å…ˆ: uploads/{job_id}_{filename}                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º (Frame Extraction)                      â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚ ãƒ»ãƒ„ãƒ¼ãƒ«: OpenCV (cv2)                                      â”‚
â”‚ ãƒ»æŠ½å‡ºé–“éš”: 2ç§’ã”ã¨ (è¨­å®šå¯èƒ½)                              â”‚
â”‚ ãƒ»æœ€å¤§ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: 500 (è¨­å®šå¯èƒ½)                            â”‚
â”‚ ãƒ»å‡ºåŠ›å½¢å¼: JPEG (å“è³ª95)                                   â”‚
â”‚ ãƒ»ä¿å­˜å…ˆ: frames/{job_id}/frame_XXXXXX_tXX.XXs.jpg          â”‚
â”‚                                                             â”‚
â”‚ ä¾‹: 10åˆ†å‹•ç”» â†’ ç´„300ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: AIç”»åƒè§£æ (Vision Analysis)                         â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚ ãƒ»AIãƒ¢ãƒ‡ãƒ«: Ollama Llama 3.2 Vision                         â”‚
â”‚ ãƒ»å‡¦ç†: å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å€‹åˆ¥ã«è§£æ                              â”‚
â”‚                                                             â”‚
â”‚ ã€è§£æå†…å®¹ã€‘                                                 â”‚
â”‚   âœ“ kill_log: ã‚­ãƒ«ãƒ­ã‚°ã®æ¤œå‡º                                â”‚
â”‚   âœ“ match_status: è©¦åˆçŠ¶æ³ (playing/victory/defeat)        â”‚
â”‚   âœ“ action_intensity: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¼·åº¦ (low/medium/high)      â”‚
â”‚   âœ“ enemy_visible: æ•µãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¦–èª                       â”‚
â”‚   âœ“ ui_elements: UIè¦ç´ ã®èª¬æ˜                               â”‚
â”‚   âœ“ scene_description: ã‚·ãƒ¼ãƒ³ã®èª¬æ˜                         â”‚
â”‚                                                             â”‚
â”‚ ã€å‡ºåŠ›å½¢å¼ã€‘                                                 â”‚
â”‚ {                                                           â”‚
â”‚   "frame_path": "frames/.../frame_000123.jpg",            â”‚
â”‚   "timestamp": 246.0,                                      â”‚
â”‚   "kill_log": true,                                        â”‚
â”‚   "action_intensity": "high",                              â”‚
â”‚   "enemy_visible": true,                                   â”‚
â”‚   ...                                                      â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ¤å®š (Clip Detection)                      â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚ ãƒ»AIãƒ¢ãƒ‡ãƒ«: Ollama Llama 3.2 Vision (Thinking)              â”‚
â”‚ ãƒ»å‡¦ç†: æ™‚ç³»åˆ—è§£æçµæœã‹ã‚‰æœ€é©ãªã‚¯ãƒªãƒƒãƒ—ã‚’æ±ºå®š               â”‚
â”‚                                                             â”‚
â”‚ ã€åˆ¤å®šåŸºæº–ã€‘                                                 â”‚
â”‚   1. ã‚­ãƒ«ãƒ­ã‚°ãŒæ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ¼ãƒ³                             â”‚
â”‚   2. action_intensity = "high" ã®ã‚·ãƒ¼ãƒ³                     â”‚
â”‚   3. å‰å¾Œ5-10ç§’ã‚’å«ã‚ã¦æ–‡è„ˆã‚’ä¿æŒ                           â”‚
â”‚   4. æœ€å°ã‚¯ãƒªãƒƒãƒ—é•·: 10ç§’                                   â”‚
â”‚   5. æœ€å¤§ã‚¯ãƒªãƒƒãƒ—é•·: 30ç§’                                   â”‚
â”‚   6. ã‚¯ãƒªãƒƒãƒ—é–“ã®é‡è¤‡ã‚’å›é¿                                 â”‚
â”‚                                                             â”‚
â”‚ ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã€‘                                       â”‚
â”‚   ãƒ»AIåˆ¤å®šå¤±æ•—æ™‚: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹æ¤œå‡º                          â”‚
â”‚   ãƒ»é€£ç¶šã‚­ãƒ«ã‚’è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—åŒ–                                â”‚
â”‚                                                             â”‚
â”‚ ã€å‡ºåŠ›å½¢å¼ã€‘                                                 â”‚
â”‚ {                                                           â”‚
â”‚   "clips": [                                               â”‚
â”‚     {"start": 120.0, "end": 145.0, "reason": "3 kills"},  â”‚
â”‚     {"start": 300.0, "end": 325.0, "reason": "clutch"},   â”‚
â”‚   ]                                                        â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: å‹•ç”»ç·¨é›†ãƒ»çµåˆ (Video Editing)                       â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚ ãƒ»ãƒ„ãƒ¼ãƒ«: FFmpeg                                            â”‚
â”‚ ãƒ»å‡¦ç†: é«˜å“è³ªã‚¯ãƒªãƒƒãƒ—æŠ½å‡º + çµåˆ                           â”‚
â”‚                                                             â”‚
â”‚ ã€å€‹åˆ¥ã‚¯ãƒªãƒƒãƒ—æŠ½å‡ºã€‘                                         â”‚
â”‚   ffmpeg -ss {start} -i {input}                            â”‚
â”‚          -t {duration}                                     â”‚
â”‚          -c:v libx264 -crf 18 -preset slow                 â”‚
â”‚          -c:a aac -b:a 192k                                â”‚
â”‚          temp_clip_{N}.mp4                                 â”‚
â”‚                                                             â”‚
â”‚ ã€ã‚¯ãƒªãƒƒãƒ—çµåˆã€‘                                             â”‚
â”‚   concat_list.txt:                                         â”‚
â”‚     file 'temp_clip_001.mp4'                               â”‚
â”‚     file 'temp_clip_002.mp4'                               â”‚
â”‚     ...                                                    â”‚
â”‚                                                             â”‚
â”‚   ffmpeg -f concat -safe 0                                 â”‚
â”‚          -i concat_list.txt                                â”‚
â”‚          -c copy                                           â”‚
â”‚          {output}.mp4                                      â”‚
â”‚                                                             â”‚
â”‚ ã€å“è³ªè¨­å®šã€‘                                                 â”‚
â”‚   ãƒ»CRF: 18 (é«˜å“è³ª)                                        â”‚
â”‚   ãƒ»Preset: slow (ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æœ€é©åŒ–)                         â”‚
â”‚   ãƒ»FPS: å…ƒå‹•ç”»ã‚’ç¶­æŒ (60fps/120fpså¯¾å¿œ)                   â”‚
â”‚   ãƒ»è§£åƒåº¦: å…ƒå‹•ç”»ã‚’ç¶­æŒ                                    â”‚
â”‚   ãƒ»ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª: AAC 192kbps                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: å®Œæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰                                   â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚ ãƒ»å‡ºåŠ›å…ˆ: output/{job_id}_highlight.mp4                     â”‚
â”‚ ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: /api/download/{job_id}                   â”‚
â”‚ ãƒ»çµ±è¨ˆæƒ…å ±: ã‚¯ãƒªãƒƒãƒ—æ•°ã€å‡¦ç†æ™‚é–“ã€ãƒ•ãƒ¬ãƒ¼ãƒ æ•°                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è©³ç´°å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

### Step 1: å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```python
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (main.js)
const formData = new FormData();
formData.append('file', selectedFile);

fetch('/api/upload', {
    method: 'POST',
    body: formData
})
```

**å‡¦ç†å†…å®¹:**
1. ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼æ¤œè¨¼ (.mp4, .mkv, .avi, .mov)
2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæ¤œè¨¼ (æœ€å¤§5GB)
3. ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªJob IDã‚’ç”Ÿæˆ (UUID)
4. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`uploads/`ã«ä¿å­˜
5. ã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’`active_jobs`ã«ç™»éŒ²

**å¿œç­”:**
```json
{
    "job_id": "uuid-xxxx-xxxx",
    "filename": "gameplay.mp4",
    "message": "File uploaded successfully"
}
```

---

### Step 2: ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º (FrameExtractor)

**æŠ€è¡“:**
- OpenCV (cv2.VideoCapture)
- JPEGåœ§ç¸® (å“è³ª95)

**å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯:**
```python
# src/frame_extractor.py

cap = cv2.VideoCapture(video_path)
fps = cap.get(cv2.CAP_PROP_FPS)
frame_interval = int(fps * interval_seconds)  # 2ç§’ â†’ 120ãƒ•ãƒ¬ãƒ¼ãƒ 

while True:
    ret, frame = cap.read()
    if frame_count % frame_interval == 0:
        timestamp = frame_count / fps
        cv2.imwrite(f"frame_{count:06d}_t{timestamp:.2f}s.jpg", frame)
```

**å‡ºåŠ›ä¾‹:**
```
frames/job-uuid/
â”œâ”€â”€ frame_000000_t0.00s.jpg    (0ç§’åœ°ç‚¹)
â”œâ”€â”€ frame_000001_t2.00s.jpg    (2ç§’åœ°ç‚¹)
â”œâ”€â”€ frame_000002_t4.00s.jpg    (4ç§’åœ°ç‚¹)
â””â”€â”€ ...
```

**é€²æ—é€šçŸ¥ (WebSocket):**
```json
{
    "stage": "frame_extraction",
    "progress": 10,
    "message": "ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™..."
}
```

---

### Step 3: AIç”»åƒè§£æ (OllamaClient)

**ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:**
- Llama 3.2 Vision (11B parameters)
- ãƒ­ãƒ¼ã‚«ãƒ«æ¨è«– (Ollama)

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ:**
```python
VISION_PROMPT = """
Analyze this FPS game screenshot and provide JSON:

{
    "kill_log": boolean,        // ã‚­ãƒ«é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹
    "match_status": string,     // playing/victory/defeat/result_screen/unknown
    "action_intensity": string, // low/medium/high
    "enemy_visible": boolean,   // æ•µãŒè¦–èªã§ãã‚‹ã‹
    "ui_elements": string,      // ç°¡æ½”ãªUIèª¬æ˜
    "scene_description": string // ã‚·ãƒ¼ãƒ³ã®èª¬æ˜
}

Only respond with valid JSON.
"""
```

**APIå‘¼ã³å‡ºã—:**
```python
# src/ollama_client.py

response = requests.post(
    "http://localhost:11434/api/generate",
    json={
        "model": "llama3.2-vision",
        "prompt": vision_prompt,
        "images": [base64_encoded_image],
        "stream": False,
        "format": "json"
    }
)
```

**è§£æçµæœä¾‹:**
```json
{
    "frame_path": "frames/.../frame_000123_t246.00s.jpg",
    "timestamp": 246.0,
    "kill_log": true,
    "match_status": "playing",
    "action_intensity": "high",
    "enemy_visible": true,
    "ui_elements": "Health: 75, Ammo: 18/120, Kill feed visible",
    "scene_description": "Player engaged in close-quarter combat, enemy eliminated"
}
```

**é€²æ—é€šçŸ¥:**
```json
{
    "stage": "ai_analysis",
    "progress": 50,
    "message": "ãƒ•ãƒ¬ãƒ¼ãƒ è§£æä¸­: 150/300"
}
```

---

### Step 4: ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ¤å®š

**Thinkingãƒ¢ãƒ‡ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:**
```python
THINKING_PROMPT = """
You are a video editing assistant. Based on FPS game analysis:

Timeline:
[0.0s] Kill: false, Action: low
[2.0s] Kill: false, Action: medium
[120.0s] Kill: true, Action: high  â† Highlight!
[122.0s] Kill: true, Action: high  â† Highlight!
[124.0s] Kill: true, Action: high  â† Highlight!
...

Criteria:
1. kill_log = true (kills happened)
2. action_intensity = "high"
3. Include 5-10s before/after for context
4. Min clip: 10s, Max clip: 30s
5. Avoid overlapping clips

Response format:
{
    "clips": [
        {"start": 115.0, "end": 135.0, "reason": "3 consecutive kills"},
        {"start": 300.0, "end": 325.0, "reason": "intense firefight"}
    ]
}
"""
```

**ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œå‡º:**
```python
# AIå¤±æ•—æ™‚ã®ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹æ¤œå‡º
def _fallback_clip_detection(analysis_results):
    clips = []
    kill_timestamps = [r["timestamp"] for r in analysis_results if r["kill_log"]]

    # é€£ç¶šã‚­ãƒ«ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ– (10ç§’ä»¥å†…)
    for i, ts in enumerate(kill_timestamps):
        if i == 0 or ts - kill_timestamps[i-1] > 10:
            clips.append({
                "start": max(0, ts - 5),
                "end": ts + 5,
                "reason": "Kill sequence"
            })

    return clips
```

**å‡ºåŠ›:**
```json
{
    "clips": [
        {"start": 115.0, "end": 140.0, "reason": "Triple kill combo"},
        {"start": 295.0, "end": 320.0, "reason": "Clutch 1v3"},
        {"start": 450.0, "end": 475.0, "reason": "Ace round"}
    ]
}
```

---

### Step 5: å‹•ç”»ç·¨é›† (VideoEditor)

**å€‹åˆ¥ã‚¯ãƒªãƒƒãƒ—æŠ½å‡º:**
```bash
ffmpeg -y \
  -ss 115.0 \              # é–‹å§‹ä½ç½®
  -i input.mp4 \           # å…¥åŠ›å‹•ç”»
  -t 25.0 \                # é•·ã• (140 - 115)
  -c:v libx264 \           # H.264ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯
  -crf 18 \                # å“è³ª (ä½ã„ã»ã©é«˜ç”»è³ª)
  -preset slow \           # ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æœ€é©åŒ–
  -c:a aac \               # AACã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
  -b:a 192k \              # 192kbpsã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
  temp_clip_001.mp4
```

**ã‚¯ãƒªãƒƒãƒ—çµåˆ:**
```bash
# concat_list.txt
file 'temp_clip_001.mp4'
file 'temp_clip_002.mp4'
file 'temp_clip_003.mp4'

ffmpeg -y \
  -f concat \
  -safe 0 \
  -i concat_list.txt \
  -c copy \                # å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãªã—
  output_highlight.mp4
```

**å“è³ªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
- **CRF 18**: ã»ã¼ç„¡æå¤±å“è³ªï¼ˆæ¨å¥¨: 18-23ï¼‰
- **Preset slow**: é«˜å“è³ªå„ªå…ˆï¼ˆfast/medium/slow/veryslowï¼‰
- **FPSç¶­æŒ**: å…ƒå‹•ç”»ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã‚’ä¿æŒ
- **è§£åƒåº¦ç¶­æŒ**: 1080p/1440p/4Kã‚’ãã®ã¾ã¾ç¶­æŒ

---

## å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²

### 1. app.py (FastAPI ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)

**è²¬å‹™:**
- HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæä¾›
- WebSocketé€šä¿¡ç®¡ç†
- ã‚¸ãƒ§ãƒ–ç®¡ç† (active_jobsè¾æ›¸)
- éåŒæœŸã‚¿ã‚¹ã‚¯å®Ÿè¡Œ

**ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**
```python
@app.post("/api/upload")           # å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
@app.post("/api/process/{job_id}") # å‡¦ç†é–‹å§‹
@app.get("/api/status/{job_id}")   # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
@app.get("/api/download/{job_id}") # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
@app.websocket("/ws/{job_id}")     # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡
```

---

### 2. src/frame_extractor.py (ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º)

**è²¬å‹™:**
- å‹•ç”»ã‹ã‚‰JPEGãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æŠ½å‡º
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç®¡ç†
- å‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:**
```python
class FrameExtractor:
    async def extract_frames(video_path, output_dir) -> List[str]
    def get_video_info(video_path) -> dict
```

---

### 3. src/ollama_client.py (AIè§£æ)

**è²¬å‹™:**
- Ollama APIã¨ã®é€šä¿¡
- Visionè§£æå®Ÿè¡Œ
- Thinkingåˆ¤å®šå®Ÿè¡Œ
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:**
```python
class OllamaClient:
    async def analyze_frame(frame_path) -> Dict
    async def determine_clips(analysis_results) -> List[Dict]
    def test_connection() -> bool
```

---

### 4. src/video_editor.py (å‹•ç”»ç·¨é›†)

**è²¬å‹™:**
- FFmpegã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ
- ã‚¯ãƒªãƒƒãƒ—æŠ½å‡º
- å‹•ç”»çµåˆ
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:**
```python
class VideoEditor:
    async def create_highlight(input_video, clips, output_path) -> str
    def get_video_metadata(video_path) -> Dict
    def create_9_16_crop(input_video, output_path) -> str
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚ â† ãƒ¦ãƒ¼ã‚¶ãƒ¼
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP POST /api/upload
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        FastAPI (app.py)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Upload Handler                â”‚  â”‚
â”‚  â”‚  1. Validate file              â”‚  â”‚
â”‚  â”‚  2. Generate job_id            â”‚  â”‚
â”‚  â”‚  3. Save to uploads/           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WebSocket Connection
       â”‚ /ws/{job_id}
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Background Task Processing        â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ FrameExtractor.extract_frames() â”‚ â”‚
â”‚  â”‚ â†“                               â”‚ â”‚
â”‚  â”‚ frames/{job_id}/frame_XXX.jpg   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ OllamaClient.analyze_frame()    â”‚ â”‚
â”‚  â”‚ â†’ Ollama API (11434)            â”‚ â”‚
â”‚  â”‚ â†“                               â”‚ â”‚
â”‚  â”‚ analysis_results[]              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ OllamaClient.determine_clips()  â”‚ â”‚
â”‚  â”‚ â†“                               â”‚ â”‚
â”‚  â”‚ clips[]                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ VideoEditor.create_highlight()  â”‚ â”‚
â”‚  â”‚ â†’ FFmpeg                        â”‚ â”‚
â”‚  â”‚ â†“                               â”‚ â”‚
â”‚  â”‚ output/{job_id}_highlight.mp4   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WebSocket Progress Updates
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚
â”‚ (Real-time   â”‚
â”‚  Progress)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### POST /api/upload
å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

**Request:**
```
Content-Type: multipart/form-data
file: <video_file>
```

**Response:**
```json
{
    "job_id": "uuid",
    "filename": "gameplay.mp4",
    "message": "File uploaded successfully"
}
```

---

### POST /api/process/{job_id}
å‡¦ç†ã‚’é–‹å§‹

**Response:**
```json
{
    "message": "Processing started",
    "job_id": "uuid"
}
```

---

### WebSocket /ws/{job_id}
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—æ›´æ–°

**Messages:**
```json
{
    "stage": "frame_extraction",
    "progress": 30,
    "message": "ãƒ•ãƒ¬ãƒ¼ãƒ è§£æä¸­: 90/300"
}

{
    "stage": "completed",
    "progress": 100,
    "message": "å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼",
    "output_file": "/api/download/uuid"
}
```

---

### GET /api/status/{job_id}
ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—

**Response:**
```json
{
    "id": "uuid",
    "filename": "gameplay.mp4",
    "status": "processing",
    "progress": 65,
    "frames_count": 300,
    "clips": [...],
    "created_at": "2026-01-10T12:00:00"
}
```

---

### GET /api/download/{job_id}
å®Œæˆå‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

**Response:**
```
Content-Type: video/mp4
Content-Disposition: attachment; filename="highlight_gameplay.mp4"
<binary data>
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 1. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼

**ã‚±ãƒ¼ã‚¹:**
- ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¶…é

**å‡¦ç†:**
```python
if file_ext not in ['.mp4', '.mkv', '.avi', '.mov']:
    raise HTTPException(
        status_code=400,
        detail="Invalid file type"
    )
```

---

### 2. ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºã‚¨ãƒ©ãƒ¼

**ã‚±ãƒ¼ã‚¹:**
- å‹•ç”»ãŒç ´æã—ã¦ã„ã‚‹
- ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯æœªå¯¾å¿œ

**å‡¦ç†:**
```python
try:
    cap = cv2.VideoCapture(video_path)
    if not cap.isOpened():
        raise ValueError("Cannot open video")
except Exception as e:
    job["status"] = "failed"
    job["error"] = str(e)
```

---

### 3. AIè§£æã‚¨ãƒ©ãƒ¼

**ã‚±ãƒ¼ã‚¹:**
- Ollamaæ¥ç¶šå¤±æ•—
- JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼

**å‡¦ç†:**
```python
try:
    response = requests.post(ollama_url, ...)
    result = json.loads(response.json()["response"])
except Exception as e:
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™
    return {
        "kill_log": False,
        "action_intensity": "low",
        "error": str(e)
    }
```

---

### 4. å‹•ç”»ç·¨é›†ã‚¨ãƒ©ãƒ¼

**ã‚±ãƒ¼ã‚¹:**
- FFmpegã‚³ãƒãƒ³ãƒ‰å¤±æ•—
- ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³

**å‡¦ç†:**
```python
result = subprocess.run(ffmpeg_cmd, capture_output=True)
if result.returncode != 0:
    raise RuntimeError(f"FFmpeg failed: {result.stderr}")
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ä¸¦åˆ—å‡¦ç†
```python
# ãƒ•ãƒ¬ãƒ¼ãƒ è§£æã‚’ä¸¦åˆ—åŒ–ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
with ThreadPoolExecutor(max_workers=4) as executor:
    futures = [executor.submit(analyze_frame, f) for f in frames]
    results = [f.result() for f in futures]
```

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
```python
# è§£ææ¸ˆã¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
@lru_cache(maxsize=1000)
def analyze_frame_cached(frame_hash):
    ...
```

### 3. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
```python
# å¤§å®¹é‡å‹•ç”»ã®åˆ†å‰²å‡¦ç†ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
def process_in_chunks(video_path, chunk_size=60):
    # 60ç§’ã”ã¨ã«åˆ†å‰²å‡¦ç†
    ...
```

---

## è¨­å®šã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

`config.yaml`ã§ä»¥ä¸‹ã‚’èª¿æ•´å¯èƒ½:

```yaml
# ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºé »åº¦
frame_extraction:
  interval_seconds: 2      # 1ç§’ã«å¤‰æ›´ã§è©³ç´°è§£æ
  max_frames: 500          # 200ã«æ¸›ã‚‰ã—ã¦ãƒ¡ãƒ¢ãƒªç¯€ç´„

# å‹•ç”»å“è³ª
export:
  crf: 18                  # 16ã§æ›´ã«é«˜ç”»è³ªã€23ã§è»½é‡
  preset: "slow"           # "fast"ã§é«˜é€Ÿå‡¦ç†

# AIè¨­å®š
ollama:
  vision_model: "llama3.2-vision"
  thinking_model: "llama3.2-vision"
  timeout: 120             # API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç§’æ•°
```

---

## ã¾ã¨ã‚

Auto-FPS-Clipperã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®6ã‚¹ãƒ†ãƒƒãƒ—:

1. **Upload** â†’ å‹•ç”»ã‚’å—ä¿¡ãƒ»ä¿å­˜
2. **Frame Extraction** â†’ OpenCVã§2ç§’ã”ã¨ã«ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º
3. **Vision Analysis** â†’ Ollama AIã§å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è§£æ
4. **Clip Detection** â†’ AIãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒ³ã‚’åˆ¤å®š
5. **Video Editing** â†’ FFmpegã§é«˜å“è³ªã‚¯ãƒªãƒƒãƒ—ã‚’ç”Ÿæˆ
6. **Download** â†’ å®Œæˆå‹•ç”»ã‚’é…ä¿¡

ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œçµã—ã€WebSocketã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—ã‚’æä¾›ã—ã¾ã™ã€‚
